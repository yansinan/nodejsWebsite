{% from "../public/compListTags.html" import tag as domTag %}
{% from "../public/compListTags.html" import listTags as listTags %}

{# {% extends "../default.html" %}  #}


{# <link rel="stylesheet" href="/static/themes/dorawhite/css/detail.css"> #}
<div class="detail {{serviceName}} font-normal" data-bs-main="{{post.docAlias}}">
    {# 乐队名 #}
    <div class="name">{{post.name}} {{post.alias if post.name!=post.alias else ""}}</div>
    {# 乐队图 #}
    <div class="album scrollerSnap">
        {% for image in post.listImages %}
        <img src="{{image.urlThumbsnail}}" height="100%" data-dr-url="{{image.url}}"/>{#  data-bs-toggle="modal" data-bs-target="#modalImagePreview"  #}
        {% endfor %}
    </div>
    {# 标签 #}
    {# 风格 #}
    {% if post.tags.length>0 and post.tags[0]%}
    <ul class="list-inline">
        {% for tag in post.tags %}
            {{ domTag(tag.name+"   "+tag.alias,'/search?q='+tag.name)  if tag else ""}}
        {% endfor %}
        {{ domTag(post.from,'/search?q='+post.from) if post.from!=""}}
    </ul>
    {% endif %}
    {# 介绍 #}
    <article class="">
        {{post.comments | safe}}
    </article>
    {# 友链 #}
    {% if post.listLinks.length>0%}
    <ol class="breadcrumb">
        {% for link in post.listLinks %}
        <li class="breadcrumb-item outUnderline"><a href="{{link.url}}" target="_blank">{{link.name}}</a></li>
        {% endfor %}
    </ol>
    {% endif %}
    <div class="headEnd"></div>

    {# 专辑 #}
    {% if post.objDocsRecords.length>0%}
    <div class="block title records">
        <div class="list" style="--cnt-item:{{4 if post.objDocsRecords.length > 4 else post.objDocsRecords.length}}">      
            {% for item in post.objDocsRecords %}
                {# 乐队详情页 #}
                <a onclick="window.goto('{{item.url}}')" class="item {{'hide' if loop.index > 4}} noSelect">
                    <img src="{{item.sImg}} " class="img-fluid" alt="{{item.title}} " />
                    <div class="intro">
                        <p class="title">{{item.dateTimeline}}<br><span class="hoverUnderline">{{item.name}}</span></p>
                        {# 标签 #}
                        {% if item.listFormatTags.length > 0 %}<div class="tags records">{{listTags(item.listFormatTags)}}</div>{% endif %}
                    </div>
                </a>
            {% endfor %} 
        </div>
    </div>
    {% if post.listVideos.length >3 %}<div class="more hoverUnderline" data-dr-target="records">更多</div>{% endif %}
    {% endif %}
    {# 视频 #}
    {% if post.listVideos.length>0%}
    <div class="block title videos">
        <div class="list" style="--cnt-item:{{3 if post.listVideos.length > 3 else post.listVideos.length}}">      
            {% for item in post.listVideos %}
                {# 乐队详情页 #}
                <a onclick="window.goto('{{item.url}}') " class="item videoWrapper hoverUnderline">
                    <img src="{{item.urlImg}} " class="img-fluid" alt="{{item.title}} " />
                    <span class="title">{{item.name}}</span>
                </a>
            {% endfor %} 
        </div>
    </div>
    {% if post.listVideos.length >3 %}<div class="more hoverUnderline" data-dr-target="videos">更多</div>{% endif %}
    {% endif %}
    {# 时间轴 #}
    {% if post.listTimeline.length>0%}
    <div class="block title news">
        <div class="list" style="--cnt-item:{{4 if post.listTimeline.length > 4 else post.listTimeline.length}}">      
            {% for item in post.listTimeline %}
            {# {%if post.listTimeline[loop.first]  or itme.dateYear!=post.listTimeline[loop.revindex0].dateYear %} #}
            {# <div class="year">{{ item.dateYear}}</div> #}
            {# {% endif %} #}
            <a class="item hoverUnderline" onclick="window.goto('{{item.url}}')">
                {# <span class="date" >{{ item.dateTimeline}}</span> #}
                {{ item.name }}
            </a>                            
            {% endfor %}
        </div>
    </div>
    {% if post.listTimeline.length >4 %}<div class="more hoverUnderline" data-dr-target="news">更多</div>{% endif %}
    {% endif %}    

    {# 周边 #}
    {% if post.listDocsGoods.length>0%}
    <div class="block title goods">
        <div class="list" style="--cnt-item:{{6 if post.listDocsGoods.length > 6 else post.listDocsGoods.length}}">      
            {% for item in post.listDocsGoods %}
                {# 乐队详情页 #}
                <a onclick="window.goto('{{item.url}}')" class="item {{'hide' if loop.index > 5}}">
                    <img src="{{item.sImg}} " class="img-fluid" alt="{{item.title}} " />
                    <div class="intro">
                        <p class="title"><span class="hoverUnderline">{{item.name}}</span></p>
                        {# 标签 #}
                        {# <div class="tags goods">{{listTags(item.listFormatTags)}}</div> #}
                    </div>
                </a>
            {% endfor %} 
        </div>
    </div>
    {% if post.listDocsGoods.length >6 %}<div class="more hoverUnderline" data-dr-target="goods">更多</div>{% endif %}
    {% endif %}    
    <div class="headEnd fa-play" dr-class="@playerStatus" style=""></div>

</div>
{# 浮动导航 #}
<div class="nav artist">
    <ul>
        <div class="backTop" onclick="ctrNavDetail.eBnDetailNav(event,'.album')"></div>
        {% for link in post.listNav %}
        <li class="hoverUnderline" onclick="ctrNavDetail.eBnDetailNav(event,'{{link.tar}}')">{{link.name}}</li>
        {% endfor %}
        {% if post.listHotMusics.length>0%}
        <li class="player" onclick="ctrNavDetail.eAudioToggleNow(event)"><i class="fa fa-play" dr-class="@playerStatus"></i></li>
        {% endif %}
    </ul>
    {# 精选单曲 #}
    {% if post.listHotMusics.length>0%}
    <div class="playList fa-play" dr-class="@playerStatus">
        <ul>
            {% for link in post.listHotMusics %}
            <li class="song">
                <span onclick="ctrNavDetail.eAudioToggle(event,'{{loop.index}}')" data-link="{{link.url}}" data-current-time="0 : 0 / 0 : 0">
                    {{link.name}}
                    <audio src="{{link.url}}" preload="metadata">Your browser does not support the <code>audio</code> element.</audio>
                </span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
<script>
window.ctrNavDetail={
    eBnDetailNav:function(e,strTarget){
        let offset=$offcanvasDetail.querySelector('#offcanvasDetail .detail '+ strTarget).getBoundingClientRect().top;
        offset=offset - $offcanvasDetail.getBoundingClientRect().top;
        $($offcanvasDetail)[0].scrollBy({
                top      : offset,
                left     : 0,
                behavior : 'smooth'
        });
    },
    {# 详情页导航&试听 #}
    {# playerStatus:"fa-play", #}

    {# 导航按钮 #}
    eAudioToggleNow:function(e){
        let that=window.ctrNavDetail;
        let $audio=that.getCurrentAudio();
        that.audioToggle($audio);
    },
    {# 歌曲 #}
    eAudioToggle:function(e){
        let that=window.ctrNavDetail;
        let $audio=e.currentTarget.querySelector("audio");
        {# 重新排序 #}
        {# let $ulSong=$offcanvasDetail.querySelector(".nav .playList ul"); #}
        let $lastAudio=that.getCurrentAudio();
        if($lastAudio!=$audio)$lastAudio.parentElement.parentElement.before($audio.parentElement.parentElement);
        that.audioToggle($audio);
    },
    {# 播放控制 #}
    audioToggle:function($audio){
        if(!$audio)return;
        let that=window.ctrNavDetail;
        {# 播放控制 #}
        let $listAudios=$offcanvasDetail.querySelectorAll(".nav .playList ul audio");
        $listAudios.forEach($a=>{
            if($a!=$audio){
                $a.pause();
                $a.currentTime=0;
                $a.parentElement.classList.value="";
            }
        })
        let resToggle=false;
        if($audio.paused){
            $audio.play();
            resToggle=true;
        }else $audio.pause();


        {# 显示控制 #}
        that.playerStatus=!$audio.paused ? "fa-pause" : "fa-play";
        {# 当前歌曲标记 #}
        let $song=$audio.parentElement;
        let $playerList=$song.parentElement;
        $song.classList.value="now";

        {# 更新播放时间 #}
        $audio.addEventListener('timeupdate', (e) => {
            {# let $audio=e.currentTarget; #}
            let $song=e.currentTarget.parentElement;
            $song.dataset.currentTime=ctlOffcanvasBody.getPlayerTime(e.currentTarget.currentTime) + " / " + ctlOffcanvasBody.getPlayerTime(e.currentTarget.duration);                    
        });
        return resToggle;
    },
    getCurrentAudio:function(){
        let $song=$offcanvasDetail.querySelector(".nav .playList ul li");
        if(!$song)return false;
        return $song.querySelector("audio");
    }
}
Object.defineProperties(window.ctrNavDetail,{
    playerStatus:{
        set:(v)=>{
            if($offcanvasDetail){
                let $listEleToChangeClass=$offcanvasDetail.querySelectorAll('[dr-class="@playerStatus"]');
                $listEleToChangeClass.forEach($ele=>{
                    $ele.classList.replace("fa-pause", v);
                    $ele.classList.replace("fa-play", v);
                })
            }
        }
    }
})
</script>
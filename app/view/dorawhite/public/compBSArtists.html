{# 横滚乐队名 #}
<div id="coverArtistsWrapper" class="d-none bs-wrapper-listArtist paddingTop paddingTop-md">                        
    <div class="bs-content-listArtist listArtists">
        {% for artist in listArtists|sort(false,false,"letters") %}
        {# 乐队名列表 #}
        {# <h1 class="display-1">RUBY</h1> #}
        <div class="artist artist-md d-flex align-items-center ">
            {# <div class="fixed"><div class="sImg"><img src="{{artist.sImg}}" width="0px" data-src="{{artist.sImg}}" alt="{{artist.nameTimeline}}"  class="img-fluid"/></div></div> #}
             
            <button 
                class="name btn btn-link" 
                data-dr-url="/artist___{{artist.id}}.html">
                <span 
                    tabindex="0"
                    data-bs-toggle="tooltip" 
                    data-bs-html="true" 
                    data-s-img="{{artist.sImg}}"
                    title=' '>
                    {{artist.name}}
                </span>
            </button>
            {% if artist.listNotices.length > 0%}
            <button 
                tabindex="0"
                class="noticeCnt d-flex flex-shrink-0 justify-content-center border border-1 border-dark rounded-circle" 
                data-bs-toggle="tooltip" 
                data-bs-html="true" 
                title=' '>
                +{{artist.listNotices.length}}
            </button>
            {% for doc in artist.listNotices %}<div class="notice d-none" data-dr-url="/doc___{{doc.id}}.html">{{doc.nameTimeline}}</div>{% endfor %}
            {% endif %}
            <img src="{{artist.sImg}}" width="0px" alt="{{artist.nameTimeline}}" class="sImg img-fluid"/>
        </div >
        {% endfor %}
        {# 最后一列占宽用 #}
        <div class="artist artist-md d-flex align-items-center"></div>
        <script>
        document.getElementById("coverArtistsWrapper").querySelectorAll(".artist").forEach($artist=>{
            var $listNameArtists = $artist.querySelectorAll('.name [data-bs-toggle="tooltip"]');
            if(!$listNameArtists)return;
            $listNameArtists.forEach(function ($nameArtist) {
                if($nameArtist.tooltip && $nameArtist.tooltip.dispose)$nameArtist.tooltip.dispose();
                let strClass=Math.random()>0.5 ? "sImg verticle" : "sImg";
                let tooltip = new bootstrap.Tooltip($nameArtist,{
                    trigger:"manual",
                    customClass:strClass,
                    offset:[20,0],
                    popperConfig:{
                        placement: 'top-start',
                        modifiers:[
                            {
                                name: 'preventOverflow',
                                options: {
                                    mainAxis: true, // true by default
                                    boundary: document.getElementById("coverArtistsWrapper"),
                                },
                            },
                        ]                                           
                    }
                })
                tooltip.$sImg=$artist.querySelector(".sImg");
                $nameArtist.tooltip=tooltip;
                $nameArtist.addEventListener('shown.bs.tooltip', function (e) {
                    console.log("sImg:","show.bs.tooltip");
                    let tooltip=e.target.tooltip;
                    if(tooltip && tooltip.$sImg){
                        let $inner=tooltip.tip.querySelector(".tooltip-inner");
                        let $dom=tooltip.$sImg.cloneNode(true);
                        //let $dom=new Image();
                        //$dom.src=tooltip.$sImg.src;
                        $inner.append($dom);
                        $dom.decode().then(() => {
                            $dom.classList.add("loaded");
                        }).catch((encodingError) => {
                        // Do something with the error.
                        })
                        //function eLoad(e){
                        //    let $sImg=e.currentTarget;
                        //    $inner.append($sImg);
                        //    $sImg.classList.add("loaded");
                        //}
                        //if($dom.complete)eLoad({currentTarget:$dom})
                        //else $dom.addEventListener("load",eLoad)
                    }
                })
                $nameArtist.addEventListener("mousemove",(e)=>{
                    let tooltip=e.target.tooltip
                    if(tooltip && !tooltip.tip.classList.contains("show")){
                        tooltip.tip.classList.add("show");
                    }
                });
                $nameArtist.addEventListener("mouseenter",(e)=>{
                    let tooltip=e.target.tooltip
                    if(tooltip){
                        tooltip.show();
                    }
                });

                $nameArtist.addEventListener("mouseleave",(e)=>{
                    let tooltip=e.target.tooltip
                    if(tooltip)tooltip.hide();
                });
                return tooltip;
            })

            {# 乐队名按钮 #}
            function eBnArtist(e){
                window.goto(e.currentTarget.dataset.drUrl);
            }
            let $bnArtist=$artist.querySelector("button.name");
            if($bnArtist)$bnArtist.addEventListener("click",eBnArtist)
        })
        </script>
    </div>
    {# 乐手列表 #}
    <script>
        let $coverArtistsWrapper=document.getElementById("coverArtistsWrapper");

        let slideListArtist = new BetterScroll.createBScroll('.bs-wrapper-listArtist', {
            //specifiedIndexAsContent:1,
            disableMouse: false,
            disableTouch: false,
            mouseWheel: true,
            scrollX: true,
            //startX:-1,
            scrollY: false,
            //nestedScroll: {
            //    groupId: 'cover-scrollY'
            //},
            //slide: {
            //    threshold: 100,
            //    loop: false,//TODO：可以优化为循环slide；注意：复制出来的slide需要querySelector and 设置translateY同步
            //    autoplay:false,
            //    listenFlick:false,
            //},
            useTransition: true,
            momentum: true,
            bounce: true,
            //stopPropagation: true,
            click:true,
            //tap:"tap",
            //preventDefaultException:{ tagName: /^(INPUT|TEXTAREA|BUTTON|SELECT|AUDIO|A)$/},
            probeType: 3,
            observeDOM: true ,// 开启 observe-dom 插件
        })

        {# slideListArtist.refresh(); #}

        slideListArtist.on('contentChanged', (newContent) => {
            slideListArtist.refresh();
            window.alert("beforeScrollStart");
        })
        {# slideListArtist.on('beforeScrollStart', slideListArtist.refresh) #}




        {# this.addEventListener("BS_COVER_LISTARTISTS",eInitTooltip); #}
        eInitTooltip($coverArtistsWrapper,"top-start",$coverArtistsWrapper);
        //slideListArtist.on("scroll",()=>{
        //    if(!$coverArtistsWrapper.tooltipList)return;
        //    $coverArtistsWrapper.tooltipList.forEach((tooltip)=>{
        //        if(tooltip && tooltip.tip && !tooltip.tip.hidden){
        //            tooltip.update();
        //        }
        //    });
        //})
        slideListArtist.on('scrollStart', () => {
            if(!$coverArtistsWrapper.tooltipList)return;
            $coverArtistsWrapper.tooltipList.forEach((tooltip)=>{
                if(tooltip && tooltip.tip && !tooltip.tip.hidden){
                    tooltip.hide();
                }
            });

        })
        $coverArtistsWrapper.addEventListener("click",(e)=>{
            if(e.isTrusted || !$coverArtistsWrapper.tooltipList)return;
            $coverArtistsWrapper.tooltipList.forEach((tooltip)=>{
                tooltip.hide();
            })
            //$coverArtistsWrapper.querySelector(".noticeCnt.now").classList.remove("now")
        },false)
    </script>  
</div>
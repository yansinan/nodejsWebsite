{# 时间轴内容区 #}
{% set infoPagination={page:"timeline",idDOM:"list-timeline",api:"/api/timeline/getListDOM",pageInfo:pageInfo,cateInfo:cateInfo} %}
{# 临时设置，确保不输出默认数据，且有posts #}
{# {% set posts=[] %} #}
{# 时间轴列表模板：根据url选取不同模板 #}
{% set tempList %}
    {% include './compBSTimelineColumn.html' %}
{% endset %}
{# {{containerOfList(infoPagination,tempList)}} #}
<div id="timelineWrapper" class="d-none bs-wrapper-main loading">
    {# 不指定高：手机纵向自适应高，PC在定义高度  dr-dom-append="{{infoPagination.idDOM}}"#}
    <div id="timelineContent" class="" style="" data-str-notice-end="">
        {% include '../js/timelineMM.html' %}
        <div class="pulldown-tip"></div>
        {# 每月纵向 #}
        {{tempList | safe}}
        {# 最后两个空列占位:TODO待解决 #}
        {# 月份行 手机隐藏#}
        {# <div class="container-mm end d-flex flex-column"></div> #}
        {{loading()}}
    </div>
    {% include '../js/timeline.html' %}
    <script>
        {# 内容显示控制 #}
        this["vm-"+"{{infoPagination.page}}"] = this["vm-"+"{{infoPagination.page}}"] || avalon.define({
            $id: $timelineContent,
            $loading: $timelineContent.querySelector(".loading"),
            cateId:"{{infoPagination.cateInfo._id}}",
            namePage:that.header.strAliasNav,//"{{infoPagination.page}}",
            urlApi:"{{infoPagination.api}}",
            appendDocumentList: [],
            yearCurrent:{{infoPagination.pageInfo.yearCurrent}},
            yearTotal:{{infoPagination.pageInfo.yearTotal}},
            isLoading:false,
            {# 初始化数据 #}
            init:async function(){
                return this.getMoreNews().then(res=>{
                    return Promise.resolve(res);
                });
            },
            getMoreNews: function () {
                if(this.isLoading)return Promise.resolve({msg:"loading",isEnd:this.yearTotal<=this.yearCurrent,current:this.yearCurrent});;
                let next = ( this.yearCurrent > this.yearTotal ) ? this.yearCurrent - 1 : false;
                if(!next){
                    that.removeEventListener("BS_MAIN_CONTENT_END",this.getMoreNews);
                    $timelineContent.dataset["strNoticeEnd"] = "没有更多了";
                    return Promise.resolve({msg:"succ",isEnd:this.yearTotal<=this.yearCurrent});
                }else{
                    let vm=this;
                    that.removeEventListener("BS_MAIN_CONTENT_END",vm.getMoreNews);
                    return new Promise((resolve, reject) => {
                        //that.bsTimeline.content.setAttribute("data-str-notice-end", "没有更多了");
                        //that.bsTimeline.content.dataset["strNoticeEnd"] = "就这个了";
                        vm.isLoading=true;
                        window.timelineWrapper.classList.add("loading");
                        $timelineContent.dataset["strNoticeEnd"] = "";
                        fetch(vm.urlApi+'?type=dom' + (!document.getElementById("scriptTimeline")?'|script':'') + '&typeId=' + vm.cateId + '&cateName='+ vm.namePage +'&yearCurrent=' + next)
                        .then(function(data){
                            return data.text();
                        }).then(function (data) {
                            vm.isLoading=false;
                            that.addEventListener("BS_MAIN_CONTENT_END",vm.getMoreNews);
                            // 在这个then里面我们能拿到最终的数据
                            let objData=JSON.parse(data);
                            if(objData.status==200){
                                window.timelineWrapper.classList.remove("loading");
                                $timelineContent.dataset["strNoticeEnd"] = "";
                                try{
                                    {# 按年检索 #}
                                    vm.yearCurrent=objData.data.pageInfo.yearCurrent;
                                    //vm.yearTotal=objData.data.pageInfo.yearTotal;
                                    
                                    let domToAppend = document.createRange().createContextualFragment(objData.data.dom);

                                    {# 第一次初始化时,会返回domContainer == $timelineWrapper.script #}
                                    //if(!document.getElementById("scriptTimeline") && objData.data.domContainer){
                                    //    document.getElementById("timelineWrapper").append(document.createRange().createContextualFragment(objData.data.domContainer));
                                    //}

                                    {# 清空并重新加载 #}
                                    //if(next==1){
                                    //    {# vm.$id.replaceChildren(...(vm.$id.querySelectorAll(".container-mm")),domToAppend.cloneNode(true)); #}
                                    //    {# 初始化数组，销毁bsMM #}
                                    //    //that.$listBSMM.forEach($bs=>{
                                    //    //    $bs.objBS.destroy();
                                    //    //    $bs.parentElement.remove();
                                    //    //});
                                    //    //that.$listBSMM=[];
                                    //    vm.$id.append(domToAppend.cloneNode(true));{# 插入列内容#}
                                    //    {# 第一次需要初始化 #}
                                    //    //that.resetSlideMain();
                                    //    //that.dispatchEvent(new CustomEvent("BS_TIMELINE_DOM_READY", { detail:{  } }))
                                    //}else vm.$id.append(domToAppend.cloneNode(true));{# 插入列内容#}
                                    //vm.$id.append(domToAppend.cloneNode(true));{# 插入列内容#}
                                    vm.$loading.before(domToAppend.cloneNode(true));

                                    //let id = window.requestAnimationFrame(()=>{
                                    //    window.cancelAnimationFrame(id);
                                    //});                                    
                                    {# 触发事件更新懒加载图片 #}
                                    console.debug("getMoreNews=>appendDOM:done",vm.yearCurrent,vm.yearTotal,vm.namePage);
                                    objData.bsTimeline=vm.namePage;
                                    that.dispatchEvent(new CustomEvent("BS_TIMELINE_DOM_LOADED", {
                                        detail:objData
                                    }))
                                    resolve({msg:"succ",isEnd:vm.yearTotal<=vm.yearCurrent});
                                }catch(e){
                                    window.timelineWrapper.classList.remove("loading");
                                    $timelineContent.dataset["strNoticeEnd"] = "加载错误";
                                    throw new Error("timeline加载更多内容,通信正常，返回结果错误");
                                    reject({msg:"timeline加载更多内容,通信正常，返回结果错误 ", objData});
                                }
                            }else{
                                debugger
                                reject({msg:"服务器返回错误 ", objData});
                                throw new Error("timeline加载更多内容，服务器通信错误："+objData.status);
                            }
                        })
                    }).then(res=>{
                        return Promise.resolve(res);
                    }).catch(err=>{
                        debugger
                        return Promise.reject(err);
                    });               
                }  
            }
        })
        {# that["vm-"+"{{infoPagination.page}}"].init().then(console.info); #}
        {# window.addEventListener('DOMContentLoaded', ()=>{that["vm-"+"{{infoPagination.page}}"].init().then(res=>console.warn);}, false); #}
    </script>
    <script>
        {# 页面跳转 #}
        function eNavToTimeline(e){
            let {objNew,objOld}=e.detail;
            {# 完成切换时，更新导航 #}
            console.debug("compBSTimeline::eNavToTimeline,触发NAV_AT");
            {# 移动端需要先改变样式，再触发 #}
            if(that.bsTimeline.isMobile)$timelineContent.classList.value = objNew.bsTimeline;
            window.dispatchEvent(new CustomEvent("NAV_AT", { detail:objNew, }));
            {# 改变class,控制显示隐藏,NAV_AT先监听，之后让初始进入timeline有动画效果 #}
            $timelineContent.classList.value = objNew.bsTimeline;
            {# loading #}
            window.timelineWrapper.classList.remove("loading");
        }
        this.addEventListener("NAV_TO",(e)=>{
            let vm=this["vm-"+"{{infoPagination.page}}"];
            let {objNew,objOld}=e.detail;
            {# objNew.bsMain=="artists"和timeline无关，恢复timeline的栏目筛选;否则会造成监听两次 #}
            if(objNew.bsMain=="artists"){
                $timelineContent.classList.value="";
                {# loading #}
                window.timelineWrapper.classList.add("loading");
                that.removeEventListener("NAV_TO_TIMELINE", eNavToTimeline);
                return;
            }
            {# 栏目alias,后台据此读取不同栏目 #}
            vm.namePage=objNew.bsTimeline;
            that.addEventListener("NAV_TO_TIMELINE", eNavToTimeline,{once:true});
        });
        {# timeline滚动到倒数第二年触发加载更多 #}
        this.addEventListener("BS_MAIN_CONTENT_END",this["vm-"+"{{infoPagination.page}}"].getMoreNews);
    </script>
</div>

{# 时间轴内容区 #}
{% set infoPagination={page:"timeline",idDOM:"list-timeline",api:"/api/timeline/getListDOM",pageInfo:pageInfo,cateInfo:cateInfo} %}
{# 临时设置，确保不输出默认数据，且有posts #}
{# {% set posts=[] %} #}
{# 时间轴列表模板：根据url选取不同模板 #}
{# 
{% set tempList %}
    {% include './compBSTimelineColumn.html' %}
{% endset %}
 #}
{# {{containerOfList(infoPagination,tempList)}} #}
<div id="timelineWrapper" class="d-none bs-wrapper-main">
    {# 不指定高：手机纵向自适应高，PC在定义高度  dr-dom-append="{{infoPagination.idDOM}}"#}
    <div id="timelineContent" class="heightMain-md px-0 d-block d-md-inline-flex w-auto" style="max-width:none;">
        <div class="pulldown-tip"></div>
        {# 每月纵向 #}
        {# {{tempList | safe}} #}
        {# 最后两个空列占位:TODO待解决 #}
        {# 月份行 手机隐藏#}
        {# <div class="container-mm end d-flex flex-column"></div> #}
    </div>
    {# {% include "./pagination.html" %} #}
</div>
<script>
    {# 内容显示控制 #}
    this["vm-"+"{{infoPagination.page}}"] = this["vm-"+"{{infoPagination.page}}"] || avalon.define({
        $id: document.getElementById('timelineContent'),//'{{infoPagination.idDOM}}',
        cateId:"{{infoPagination.cateInfo._id}}",
        namePage:"{{infoPagination.page}}",
        urlApi:"{{infoPagination.api}}",
        current: 1,
        totalPage:{{infoPagination.pageInfo.totalPage}},
        appendDocumentList: [],
        vmPageNation:this["vm-pagenation-"+"{{infoPagination.page}}"] || {},
        {# 初始化数据 #}
        init:function(){
            this.current=0;
            this.getMoreNews();
        },
        getMoreNews: function () {
            let vm=this;
            let next=(this.current<this.totalPage)?(this.current+1):false;
            return new Promise((resolve, reject) => {
                if(next){
                    fetch(vm.urlApi+'?type=dom&typeId=' + vm.cateId + '&current=' + next)
                    .then(function(data){
                        return data.text();
                    }).then(function (data) {
                        // 在这个then里面我们能拿到最终的数据
                        let objData=JSON.parse(data);
                        if(objData.status==200){
                            vm.current=objData.data.pageInfo.current;
                            vm.totalPage=objData.data.pageInfo.totalPage;
                            if(vm.vmPageNation){
                                vm.vmPageNation.current=vm.current;
                                vm.vmPageNation.totalPage=vm.totalPage;
                            }
                            let strToAppend=objData.data.dom;
                            let domToAppend = document.createRange().createContextualFragment(strToAppend);
                            {# 插入点 ,用querySelectorAll 防止slider复制后内容缺失#}
                            {# let listDomContainerOfList=document.querySelectorAll("[dr-dom-append="+vm.$id+"]"); #}
                            {# listDomContainerOfList.forEach(domList=>{domList.append(domToAppend.cloneNode(true))}); #}
                            {# 第一次初始化时,会返回domContainer == $timelineWrapper.script #}
                            if(objData.data.domContainer){
                                document.getElementById("bsMainContent").append(document.createRange().createContextualFragment(objData.data.domContainer));
                            }

                            {# 插入列内容#}
                            vm.$id.append(domToAppend.cloneNode(true));

                            {# 第一次需要初始化 #}
                            if(!slideMain.refresh)this.resetSlideMain();
                            slideMain.refresh();

                            resolve({msg:"succ",isEnd:vm.totalPage<=vm.current});
                        }else{
                            reject({msg:"服务器返回错误 ", objData});
                        }
                    })
                                        
                } else {
                    resolve({msg:"succ",isEnd:vm.totalPage<=vm.current})
                }
            });                
        }
    })
    this["vm-"+"{{infoPagination.page}}"].init();
</script>
{# 时间轴内容区 #}

<div id="timelineWrapper" class="d-none bs-wrapper-main">
    {# 不指定高：手机纵向自适应高，PC在定义高度 #}
    <div id="timelineContent" class="heightMain-md px-0 d-block d-md-inline-flex w-auto" style="max-width:none;">
        {# 单页模式 #}
        {% set infoPagination={page:"timeline",idDOM:"list-timeline",api:"/api/timeline/getList",pageInfo:pageInfo,cateInfo:cateInfo} %}
        {# 临时设置，确保不输出默认数据，且有posts #}
        {# {% set posts=[] %} #}
        <script>
            let objInitBSMM={
                //specifiedIndexAsContent:1,
                disableMouse: false,
                disableTouch: false,
                scrollY: true,
                scrollX: false,
                nestedScroll: {
                    groupId: 'cover-scrollY'
                },
                useTransition: true,//是否使用 CSS3 transition 动画
                momentum: true,//滚动动画
                bounce: {
                    top: true,
                    bottom: true,
                    left: true,
                    right: true
                },//回弹动画
                //outOfBoundaryDampingFactor:0.1,
                //stopPropagation: false,//阻止事件冒泡。多用在嵌套 scroll 的场景
                probeType: 3,
                mouseWheel: {
                    speed: 20,
                    invert: false,
                    easeTime: 300
                },
                scrollbar: true,
                //observeDOM: true // 开启 observe-dom 插件
            }
        </script>

        {# 每月纵向 #}
        {% for month, monthItems in posts|groupby("dateYYMM") %}
        <div class="container-mm d-flex flex-column">
            {# 月份行 手机隐藏#}
            <div class="month d-md-flex d-none">
                {{monthItems[0].dateYYMM}}
            </div>
            <div class="wapper-mm wapper-mm-md" style="white-space:normal;" dr-bs-wrapper="mm-{{month|trim}}" ms-controller="{{month|trim}}">
                {# 纵向滚动组件 #}
                <div class="d-flex flex-column" >
                    {# 日期纵向滚动容器 #}
                    {# 日期内容区 #}

                    {% for item in monthItems %}
                    <div class="item row" dr-date-doc="{{item.date}}">
                        {# 图 手机图 #}
                        <div id="timelineTitleImg{{item._id}}" class="col-6 ps-0 d-flex d-md-none">                        
                            <img src="{{item.sImg}}" alt="{{item.name}}"  class="img-fluid" alt="{{item.title}} " dr-id-doc="img{{item._id}}"/>
                        </div>

                        {# 内容&标题预览 #}
                        <div class="titleContainer col-6 col-md-12">
                            {# 日期 #}
                            {# <div class="col-auto date">{{item.dateTimeline}}</div> #}
                            {# 大标题 #}
                            <p class="title">{{item.dateTimeline}}<br>{{item.name}}</p>
                            {# 标签 #}
                            <div class="tags">
                                {{listTags(item.tags)}}
                            </div>
                            {# 图 手机隐藏纵向图 #}
                            <div id="timelineTitleImg{{item._id}}" class=" mb-8 d-md-flex d-none">                        
                                <img src="{{item.sImg}}" alt="{{item.name}}"  class="img-fluid d-md-flex d-none" alt="{{item.title}} " dr-id-doc="img{{item._id}}"/>
                            </div>
                        </div>
                    </div>

                    {% endfor %}
                </div>
                <script>
                    //initBSMM("bs-MM-"+"{{month|trim}}");
                    //function initBSMM(inId){
                        {# BScroll.use(MouseWheel) #}
                        {# BScroll.use(Slide) #}
                        {# this["bs-MM-"+"{{month|trim}}"] = this["bs-MM-"+"{{month|trim}}"] ||  new BetterScroll.createBScroll("[dr-bs-wrapper=mm-"+"{{month|trim}}"+"]", objInitBSMM) #}
                        //this["bs-MM-"+"{{month|trim}}"].on('scroll', (pos) => {
                        //    // currentPageIndex = page.pageX
                        //    console.log(pos.y);
                        //})                
                    //}  
                </script>
            </div>
        </div>
        {% endfor %}

    </div>
    {# 时间轴控制 #}
    <script>
    var $timelineWrapper = document.getElementById('timelineWrapper');
    let $timelineContent = document.getElementById('timelineContent');

    let slideMain = new BetterScroll.createBScroll($timelineWrapper, {
        //specifiedIndexAsContent:1,
        disableMouse: false,
        disableTouch: false,
        scrollX: true,
        scrollY: true,
        //nestedScroll: {
        //    groupId: 'cover-scrollY'
        //},
        //slide: {
        //    threshold: 100,
        //    loop: false,//TODO：可以优化为循环slide；注意：复制出来的slide需要querySelector and 设置translateY同步
        //    autoplay:false,
        //    listenFlick:false,
        //},
        useTransition: true,
        momentum: true,
        //momentumLimitTime:100,//{# 快速滑动的时间小于xx开启#}
        //momentumLimitDistance:50,//{# 快速滑动的距离大于xx开启#}
        deceleration:0.005,//{# momentum 动画的减速度 #}
        swipeTime:300,//{# momentum 动画时长 #}
        bounce: {
            top: true,
            bottom: false,
            left: true,
            right: true
        },
        mouseWheel: {
            speed: 50,
            invert: false,
            easeTime: 100
        },
        observeDOM: true ,// 开启 observe-dom 插件
        stopPropagation: false,
        probeType: 3,
    })
    //slideMain.on('slidePageChanged', (page) => {
    //    // currentPageIndex = page.pageX
    //})
    //slideMain.on('slideWillChange', (page) => {
    //    currentPageIndex = page.pageX;
    //    console.log("slideMain.on(slideWillChange)",page,this.header.listNav[currentPageIndex]);
    //    {# history路由 #}
    //    window.history.pushState({}, "{{site.title}}|"+ this.header.listNav[currentPageIndex].name, this.header.listNav[currentPageIndex].url);//设置状态
    //    //listBnNav.addClass("bg-light text-dark").removeClass("bg-dark text-light");
    //    //bnNav.addClass("bg-dark text-light").removeClass("bg-light text-dark");             
    //})
    {# 页面重新加载时，路由到指定的slide页 #}
    //window.addEventListener('DOMContentLoaded', (event) => {
    //    if(this.header.idxNav>=0){
    //        slideMain.goToPage(this.header.idxNav,0);
    //    }
    //});



    {# 月份计算坐标 #}
    let $listMM=$timelineWrapper.querySelectorAll(".wapper-mm");
    $listMM.forEach(($bsMM)=>{
        $bsMM.initProperty=function(){
            Object.defineProperties($bsMM,{
                $docNow:{
                    get:()=>{
                        let $mmNow=this;
                        {# 查询当前日期 #}
                        let topMM=$mmNow.getBoundingClientRect().top;
                        let $listDocs=$mmNow.querySelectorAll("[dr-date-doc]");
                        $mmNow.$docLast=$mmNow._$docNow || false;
                        $mmNow._$docNow=Array.from($listDocs).find(($doc,idx)=>{
                            return $doc.getBoundingClientRect().bottom > topMM;
                        });
                        return $mmNow._$docNow;
                    },
                    configurable:true,
                },
                isDateNew:{
                    get:()=>(this.$docLast != this._$docNow),
                },
                strDateNow:{
                    get:()=>{return this._$docNow ? this.$docNow.getAttribute("dr-date-doc") : false ;},
                },
                strDateLast:{
                    get:()=>{return this.$docLast ? this.$docLast.getAttribute("dr-date-doc") : false ;},
                },
                idxMM:{
                    get:()=>(this.getAttribute("ms-controller")),
                },
                objName:{
                    get:()=>("bs-"+this.idxMM),
                },
            })            
        }
        $bsMM.initProperty();
    })

    {# 上一个当前月 #}
    let $mmLast=$listMM[0];
    let $mmNow=$listMM[0];
    Object.defineProperties(slideMain,{
        strDateNow:{
            get:()=>{return slideMain.$docNow ? slideMain.$docNow.getAttribute("dr-date-doc") : false ;},
        },
        strDateLast:{
            get:()=>{return slideMain.$docLast ? slideMain.$docLast.getAttribute("dr-date-doc") : false ;},
        },
        isMobile:{
            get:()=>{return $timelineContent.clientWidth == $timelineWrapper.clientWidth ;},
        },
        paddingTop:{
            get:()=>($timelineWrapper.getBoundingClientRect().top),
        },
        paddingLeft:{
            get:()=>($timelineWrapper.getBoundingClientRect().left),
        },
    })
    slideMain.findMMNow=function(){
        let idxNearest = 0;
        let $mmOut = false;
        if(slideMain.isMobile){
            {# 移动：横向不移动，宽相等第一个跨出上边的 #}
            //let paddingTopTimelineWrapper=$timelineWrapper.getBoundingClientRect().top;
            $mmOut=Array.from($listMM).find(($mm,idx)=>{
                idxNearest = idx;
                return $mm.getBoundingClientRect().bottom > slideMain.paddingTop;
            });
        }else{
            {# PC:第一个跨出左屏幕的 ,同时记录最后一个 x <-pos.x #}
            //let paddingLeftTimelineWrapper=$timelineWrapper.getBoundingClientRect().left;
            $mmOut=Array.from($listMM).find(($mm,idx)=>{
                idxNearest = idx;
                //return $mm.getBoundingClientRect().right > -pos.x;
                return $mm.getBoundingClientRect().left + ($mm.getBoundingClientRect().width*3/4) > slideMain.paddingLeft;
            });
                    
        }
        $mmNow=false;   
        if($mmOut){
            $mmNow=$mmOut;
        }else{
            $mmNow = $listMM[idxNearest+1] ? $listMM[idxNearest+1] : ($listMM[idxNearest]?$listMM[idxNearest]:false) ;
            debugger;
        }
        if(!$mmNow)debugger;
        else{
            {# 是否需要改变class #}
            if($mmNow!=$mmLast){                
                $mmLast.classList.remove("now");
                $mmLast=$mmNow;                
            }
            $mmNow.classList.add("now");
            return $mmNow;
        }
        return false;
    }
    {# 查找当前日期，并触发事件 #}
    slideMain.funFindDateNow=function(){
        $mmNow=slideMain.findMMNow();
        {# 查询当前日期 #}
        if($mmNow)slideMain.$docNow=$mmNow.$docNow;
        else debugger;
        return slideMain.$docNow;
        //let topMM=$mmNow.getBoundingClientRect().top;
        //let $listDocs=$mmNow.querySelectorAll("[dr-date-doc]");
        //slideMain.$docNow=Array.from($listDocs).find(($doc,idx)=>{
        //    return $doc.getBoundingClientRect().bottom > topMM;
        //});
        //return slideMain.$docNow;
    }
    {# 设置class标记，并恢复上一个 #}
    slideMain.getNewStrDate=function(){
        if(slideMain.$docNow){
            slideMain.$docLast=slideMain.$docLast || slideMain.$docNow;
            if(slideMain.strDateNow != slideMain.strDateLast){
                console.log("timeline new Date",slideMain.strDateLast,"==>",slideMain.strDateNow);
                {# 更新last #}
                slideMain.$docLast = slideMain.$docNow;
                return slideMain.strDateNow;
            }
        }else debugger;
        return false
    }
    {# 触发外部事件的逻辑 #}
    slideMain.checkEvent=function(isNewDateInMM=false){
        let strNewDate=slideMain.getNewStrDate();
        if((strNewDate || isNewDateInMM)&& slideMain.enabled){
            {# 触发事件 #}
            that.dispatchEvent(new CustomEvent("BS_MAIN_DATE_CHANGE", {
                detail:{
                    strDateNow:slideMain.strDateNow,
                }
            }))
        }
    }
    slideMain.on('scroll', (pos) => {

        //$mmNow=slideMain.findMMNow(pos);
        //if($mmNow)slideMain.$docNow=$mmNow.$docNow;//slideMain.funFindDateNow($mmNow);
        //else debugger;

        slideMain.funFindDateNow();
        {# 日期变化，且用户操作产生的，才触发同步通知 #}
        slideMain.checkEvent();
    })

    slideMain.scroller.animater.hooks.on('end', () => {
        slideMain.enable();
        slideMain.idxMMScrollingTo=false;
        console.log("时间轴animater.end停止");
        //that.dispatchEvent(new CustomEvent("BS_TIMELINE_SCROLL_END"));
    })
    slideMain.scroller.hooks.on('scrollEnd', () => {
        slideMain.enable();
        slideMain.idxMMScrollingTo=false;
        console.log("时间轴scrollEnd停止");
        //that.dispatchEvent(new CustomEvent("BS_TIMELINE_SCROLL_END"));
    })
    this.eDateChange=function(e){
        {# 查找月份，保存doc #}
        let xScrollTimeline = 0;//-($mmTo.getBoundingClientRect().left);
        let yScrollTimeline = 0 ;
        {# 方案B：用idxMM查找$ #}
        let strMMIdx=e.detail.strDateNow.substr(0,7);
        strMMIdx=strMMIdx.split("-")[0]+parseInt(strMMIdx.split("-")[1]);

        //let $mmTo=Array.from($listMM).find(($mm,idx)=>{
        //    let $listDocs=$mm.querySelectorAll("[dr-date-doc]");
        //    let $docTo=Array.from($listDocs).find(($doc,idx)=>{
        //        return $doc.getAttribute("dr-date-doc") == e.detail.strDateNow;
        //    });
        //    {# 累加x位置 #}
        //    if(!$docTo)xScrollTimeline-=$mm.parentElement.clientWidth;
        //    return $docTo ? true : false;
        //});

        let $mmTo=$timelineContent.querySelector("[dr-bs-wrapper='mm-"+strMMIdx+"']");

        if(!$mmTo){
            console.warn("月份超出范围");
            return false;
        }
        {# PC:计算横坐标，手机应该是0 #}
        xScrollTimeline = -($mmTo.getBoundingClientRect().left-slideMain.paddingLeft);
        if(slideMain.isMobile){
            {# 移动端：计算纵坐标 #}
            let $dateTo=$mmTo.querySelector("[dr-date-doc='" + e.detail.strDateNow + "']");
            if($dateTo)yScrollTimeline = -($dateTo.getBoundingClientRect().top-slideMain.paddingTop);
            else {
                console.warn("日期超出月份");
                return false;                    
            }
        }
        {# 滚动timelineMain #}{# 防止循环控制 ,防止两次scrollTo同一个位置#}
        if((slideMain.strDateNow != e.detail.strDateNow) && ($mmTo.idxMM != slideMain.idxMMScrollingTo)){
            slideMain.disable();
            console.log("e:timeline:"+e.type,"时间轴按月可以移动",$mmTo.idxMM,"==>",slideMain.idxMMScrollingTo);
            slideMain.idxMMScrollingTo=$mmTo.idxMM;
            slideMain.scrollBy(xScrollTimeline,yScrollTimeline,500);
        };
        {# 滚动月份 #}{# 防止循环控制 #}
        if($mmTo.strDateNow != e.detail.strDateNow){
            let $docTo=$mmTo.querySelector("[dr-date-doc='" + e.detail.strDateNow + "']");
            if(!$docTo)return;
            //let yScrollMM=$docTo.getBoundingClientRect().top;
            let strMMIdx=e.detail.strDateNow.substr(0,7);
            strMMIdx=strMMIdx.split("-")[0]+parseInt(strMMIdx.split("-")[1]);
            console.log("e:timeline:"+e.type,"时间轴月内可以移动",$mmTo.idxMM+"."+slideMain.strDateNow,"==>",e.detail.strDateNow);
            that["bs-"+strMMIdx].scrollToElement($docTo,2000);
        }
        return $mmTo;
    }

    this.addEventListener("BS_TIMELINE_BAR_DATE_CHANGE",this.eDateChange);
    {# 保留月份滚 #}
    this.addEventListener("BS_TIMELINE_BAR_DATE_CHANGE_FINAL",this.eDateChange)
    {# 保留月份滚----end #}

    {# timelineBar 防止冲突控制 #}
    //this.addEventListener("BS_TIMELINE_BAR_SCROLL_START",(e)=>{slideMain.disable()});
    //his.addEventListener("BS_TIMELINE_BAR_SCROLL_END",(e)=>{
    //   slideMain.enable();
    //);

    var mutationObserver = new MutationObserver(function (mutations) {
        
        let status=window.getComputedStyle($timelineWrapper).getPropertyValue('display');
        {# //显示时初始化内容 #}
        if(status!="none"){
            //let domListBSMM=document.querySelectorAll("[dr-bs-wrapper]");
            $listMM.forEach(($bsMM)=>{
                let idxMM=$bsMM.getAttribute("ms-controller");
                let objName="bs-"+idxMM;
                {# 只初始化一次，防止事件多次触发 #}
                if(!that[objName]){
                    that[objName]=that[objName] ||  new BetterScroll.createBScroll($bsMM, objInitBSMM)
                    that[objName].on('beforeScrollStart', that[objName].refresh)
                    that[objName].on("scroll",(pos)=>{//this===MutationObserver
                        
                        if($bsMM.classList.contains("now")){
                            slideMain.$docNow=$bsMM.$docNow;
                            {# 当前月份滚动 && #}{# 日期变化，且用户操作产生的，才触发同步通知 #}
                            slideMain.checkEvent($bsMM.isDateNew);
                        }
                    })
                    that[objName].scroller.animater.hooks.on('end', () => {
                        slideMain.enable();
                        console.log("时间轴:月份end停止");
                    })
                    that[objName].scroller.hooks.on('scrollEnd', () => {
                        slideMain.enable();
                        console.log("时间轴:月份scrollEnd停止");
                        //that.dispatchEvent(new CustomEvent("BS_TIMELINE_SCROLL_END"));
                    })                    
                }
                that[objName].refresh();
            })
            console.log("监听到#timelineWrapper显示，初始化纵向月份");
        }
        return;
    })

    mutationObserver.observe($timelineWrapper, {
        childList: true, // 子节点的变动（新增、删除或者更改）
        attributes: true, // 属性的变动
        attributeFilter: ['class', 'style'], // 观察特定属性
        //characterData: true, // 节点内容或节点文本的变动
        //subtree: true // 是否将观察器应用于该节点的所有后代节点
    })


    </script>

</div>
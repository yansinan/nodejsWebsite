{# 时间轴内容区 #}
{% set infoPagination={page:"timeline",idDOM:"list-timeline",api:"/api/timeline/getListDOM",pageInfo:pageInfo,cateInfo:cateInfo} %}
{# 临时设置，确保不输出默认数据，且有posts #}
{# {% set posts=[] %} #}
{# 时间轴列表模板：根据url选取不同模板 #}
{% set tempList %}
    {% include './compBSTimelineColumn.html' %}
{% endset %}
{# {{containerOfList(infoPagination,tempList)}} #}
<div id="timelineWrapper" class="d-none bs-wrapper-main">
    {# 不指定高：手机纵向自适应高，PC在定义高度  dr-dom-append="{{infoPagination.idDOM}}"#}
    <div id="timelineContent" class="" style="">
        {% include '../js/timelineMM.html' %}
        <div class="pulldown-tip"></div>
        {# 每月纵向 #}
        {{tempList | safe}}
        {# 最后两个空列占位:TODO待解决 #}
        {# 月份行 手机隐藏#}
        {# <div class="container-mm end d-flex flex-column"></div> #}
        <div class="loading"></div>
    </div>
    {# {% include "./pagination.html" %} #}
    {% include '../js/timeline.html' %}
    <script>
        {# 页面跳转 #}
        this.addEventListener("NAV_TO",(e)=>{
            let vm=this["vm-"+"{{infoPagination.page}}"];
            let {objNew,objOld}=e.detail;
            {# objNew.bsMain=="artists"和timeline无关，不响应;否则会造成监听两次 #}
            if(objNew.bsMain=="artists")return;
            {# 栏目alias,后台据此读取不同栏目 #}
            vm.namePage=e.detail.objNew.bsTimeline;
            {# vm加载数据 #}
            //vm.getMoreNews().then(res=>{
            //});
            function eMainToTimelineFinal(e){
                {# bsTimeline移动到开始 #}
                {# if(that.bsTimeline.scrollTo)that.bsTimeline.scrollTo(0,0,1000); #}
                {# 完成切换时，更新导航 #}
                window.dispatchEvent(new CustomEvent("NAV_AT", { detail:objNew, }));
            }            
            that.addEventListener("BS_COVER_TIMELINE_FINAL", eMainToTimelineFinal,{once:true});
            {# 改变class,控制显示隐藏 #}
            $timelineContent.classList.value = objNew.bsTimeline;
        })
    </script>
    <script>
        {# 内容显示控制 #}
        this["vm-"+"{{infoPagination.page}}"] = this["vm-"+"{{infoPagination.page}}"] || avalon.define({
            $id: $timelineContent,
            cateId:"{{infoPagination.cateInfo._id}}",
            namePage:that.header.strAliasNav,//"{{infoPagination.page}}",
            urlApi:"{{infoPagination.api}}",
            appendDocumentList: [],
            //vmPageNation:this["vm-pagenation-"+"{{infoPagination.page}}"] || {},
            yearCurrent:{{infoPagination.pageInfo.yearCurrent}},
            yearTotal:{{infoPagination.pageInfo.yearTotal}},
            {# 初始化数据 #}
            init:async function(){
                return this.getMoreNews().then(res=>{
                    return Promise.resolve(res);
                });
            },
            getMoreNews: function () {
                let vm=this;
                let next = ( this.yearCurrent > this.yearTotal ) ? this.yearCurrent - 1 : false;
                return new Promise((resolve, reject) => {
                    if(next){
                        fetch(vm.urlApi+'?type=dom' + (!document.getElementById("scriptTimeline")?'|script':'') + '&typeId=' + vm.cateId + '&cateName='+ vm.namePage +'&yearCurrent=' + next)
                        .then(function(data){
                            return data.text();
                        }).then(function (data) {
                            // 在这个then里面我们能拿到最终的数据
                            let objData=JSON.parse(data);
                            if(objData.status==200){
                                {# 按年检索 #}
                                vm.yearCurrent=objData.data.pageInfo.yearCurrent;
                                vm.yearTotal=objData.data.pageInfo.yearTotal;
                                
                                //if(vm.vmPageNation){
                                //    vm.vmPageNation.current=vm.current;
                                //    vm.vmPageNation.totalPage=vm.totalPage;
                                //}
                                let strToAppend=objData.data.dom;
                                let domToAppend = document.createRange().createContextualFragment(strToAppend);
                                {# 插入点 ,用querySelectorAll 防止slider复制后内容缺失#}
                                {# let listDomContainerOfList=document.querySelectorAll("[dr-dom-append="+vm.$id+"]"); #}
                                {# listDomContainerOfList.forEach(domList=>{domList.append(domToAppend.cloneNode(true))}); #}

                                {# 第一次初始化时,会返回domContainer == $timelineWrapper.script #}
                                if(!document.getElementById("scriptTimeline") && objData.data.domContainer){
                                    document.getElementById("timelineWrapper").append(document.createRange().createContextualFragment(objData.data.domContainer));
                                }

                                {# 清空并重新加载 #}
                                //if(next==1){
                                //    {# vm.$id.replaceChildren(...(vm.$id.querySelectorAll(".container-mm")),domToAppend.cloneNode(true)); #}
                                //    {# 初始化数组，销毁bsMM #}
                                //    //that.$listBSMM.forEach($bs=>{
                                //    //    $bs.objBS.destroy();
                                //    //    $bs.parentElement.remove();
                                //    //});
                                //    //that.$listBSMM=[];
                                //    vm.$id.append(domToAppend.cloneNode(true));{# 插入列内容#}
                                //    {# 第一次需要初始化 #}
                                //    //that.resetSlideMain();
                                //    //that.dispatchEvent(new CustomEvent("BS_TIMELINE_DOM_READY", { detail:{  } }))
                                //}else vm.$id.append(domToAppend.cloneNode(true));{# 插入列内容#}
                                vm.$id.append(domToAppend.cloneNode(true));{# 插入列内容#}
                                {# 触发事件更新懒加载图片 #}
                                that.dispatchEvent(new CustomEvent("BS_TIMELINE_DOM_LOADED", {
                                    detail:objData
                                }))
                                resolve({msg:"succ",isEnd:vm.totalPage<=vm.current});
                            }else{
                                reject({msg:"服务器返回错误 ", objData});
                            }
                        })
                                            
                    } else {
                        resolve({msg:"succ",isEnd:vm.totalPage<=vm.current})
                    }
                });                
            }
        })
        {# that["vm-"+"{{infoPagination.page}}"].init().then(console.info); #}
        {# window.addEventListener('DOMContentLoaded', ()=>{that["vm-"+"{{infoPagination.page}}"].init().then(res=>console.warn);}, false); #}
    </script>
</div>

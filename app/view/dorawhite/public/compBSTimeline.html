{# 时间轴内容区 #}

<div id="timelineWrapper" class="d-none bs-wrapper-main">
    {# 不指定高：手机纵向自适应高，PC在定义高度 #}
    <div id="timelineContent" class="heightMain-md px-0 d-block d-md-inline-flex w-auto" style="max-width:none;">
        {# 单页模式 #}
        {% set infoPagination={page:"timeline",idDOM:"list-timeline",api:"/api/timeline/getList",pageInfo:pageInfo,cateInfo:cateInfo} %}
        {# 临时设置，确保不输出默认数据，且有posts #}
        {# {% set posts=[] %} #}
        <script>
            let objInitBSMM={
                //specifiedIndexAsContent:1,
                disableMouse: false,
                disableTouch: false,
                scrollY: true,
                scrollX: false,
                nestedScroll: {
                    groupId: 'cover-scrollY'
                },
                useTransition: true,//是否使用 CSS3 transition 动画
                momentum: true,//滚动动画
                bounce: {
                    top: true,
                    bottom: true,
                    left: true,
                    right: true
                },//回弹动画
                //outOfBoundaryDampingFactor:0.1,
                //stopPropagation: false,//阻止事件冒泡。多用在嵌套 scroll 的场景
                probeType: 3,
                mouseWheel: {
                    speed: 20,
                    invert: false,
                    easeTime: 300
                },
                scrollbar: true,
                //observeDOM: true // 开启 observe-dom 插件
            }
        </script>

        {# 每月纵向 #}
        {% for month, monthItems in posts|groupby("dateYYMM") %}
        <div class="container-mm d-flex flex-column">
            {# 月份行 手机隐藏#}
            <div class="month d-md-flex d-none">
                {{monthItems[0].dateYYMM}}
            </div>
            <div class="wapper-mm wapper-mm-md" style="white-space:normal;" dr-bs-wrapper="mm-{{month|trim}}" ms-controller="{{month|trim}}">
                {# 纵向滚动组件 #}
                <div class="d-flex flex-column" >
                    {# 日期纵向滚动容器 #}
                    {# 日期内容区 #}

                    {% for item in monthItems %}
                    <div class="item row" dr-date-doc="{{item.date}}">
                        {# 图 手机图 #}
                        <div id="timelineTitleImg{{item._id}}" class="col-6 ps-0 d-flex d-md-none">                        
                            <img src="{{item.sImg}}" alt="{{item.name}}"  class="img-fluid" alt="{{item.title}} " dr-id-doc="img{{item._id}}"/>
                        </div>

                        {# 内容&标题预览 #}
                        <div class="titleContainer col-6 col-md-12">
                            {# 日期 #}
                            {# <div class="col-auto date">{{item.dateTimeline}}</div> #}
                            {# 大标题 #}
                            <p class="title">{{item.dateTimeline}}<br>{{item.name}}</p>
                            {# 标签 #}
                            <div class="tags">
                                {{listTags(item.tags)}}
                            </div>
                            {# 图 手机隐藏纵向图 #}
                            <div id="timelineTitleImg{{item._id}}" class=" mb-8 d-md-flex d-none">                        
                                <img src="{{item.sImg}}" alt="{{item.name}}"  class="img-fluid d-md-flex d-none" alt="{{item.title}} " dr-id-doc="img{{item._id}}"/>
                            </div>
                        </div>
                    </div>

                    {% endfor %}
                </div>
                <script>
                    //initBSMM("bs-MM-"+"{{month|trim}}");
                    //function initBSMM(inId){
                        {# BScroll.use(MouseWheel) #}
                        {# BScroll.use(Slide) #}
                        {# this["bs-MM-"+"{{month|trim}}"] = this["bs-MM-"+"{{month|trim}}"] ||  new BetterScroll.createBScroll("[dr-bs-wrapper=mm-"+"{{month|trim}}"+"]", objInitBSMM) #}
                        //this["bs-MM-"+"{{month|trim}}"].on('scroll', (pos) => {
                        //    // currentPageIndex = page.pageX
                        //    console.log(pos.y);
                        //})                
                    //}  
                </script>
            </div>
        </div>
        {% endfor %}

    </div>
    {# 时间轴控制 #}
    <script>
    var $timelineWrapper = document.getElementById('timelineWrapper');

    let slideMain = new BetterScroll.createBScroll($timelineWrapper, {
        //specifiedIndexAsContent:1,
        disableMouse: false,
        disableTouch: false,
        scrollX: true,
        scrollY: true,
        //nestedScroll: {
        //    groupId: 'cover-scrollY'
        //},
        //slide: {
        //    threshold: 100,
        //    loop: false,//TODO：可以优化为循环slide；注意：复制出来的slide需要querySelector and 设置translateY同步
        //    autoplay:false,
        //    listenFlick:false,
        //},
        useTransition: true,
        momentum: true,
        //momentumLimitTime:100,//{# 快速滑动的时间小于xx开启#}
        //momentumLimitDistance:50,//{# 快速滑动的距离大于xx开启#}
        deceleration:0.005,//{# momentum 动画的减速度 #}
        swipeTime:300,//{# momentum 动画时长 #}
        bounce: {
            top: true,
            bottom: false,
            left: true,
            right: true
        },
        mouseWheel: {
            speed: 50,
            invert: false,
            easeTime: 100
        },
        observeDOM: true ,// 开启 observe-dom 插件
        stopPropagation: false,
        probeType: 3,
    })
    //slideMain.on('slidePageChanged', (page) => {
    //    // currentPageIndex = page.pageX
    //})
    //slideMain.on('slideWillChange', (page) => {
    //    currentPageIndex = page.pageX;
    //    console.log("slideMain.on(slideWillChange)",page,this.header.listNav[currentPageIndex]);
    //    {# history路由 #}
    //    window.history.pushState({}, "{{site.title}}|"+ this.header.listNav[currentPageIndex].name, this.header.listNav[currentPageIndex].url);//设置状态
    //    //listBnNav.addClass("bg-light text-dark").removeClass("bg-dark text-light");
    //    //bnNav.addClass("bg-dark text-light").removeClass("bg-light text-dark");             
    //})
    {# 页面重新加载时，路由到指定的slide页 #}
    //window.addEventListener('DOMContentLoaded', (event) => {
    //    if(this.header.idxNav>=0){
    //        slideMain.goToPage(this.header.idxNav,0);
    //    }
    //});

    {# 按月或者按日期滚动时触发事件 #}
    this.funScrollTimeline=function($mmNow){
        {# 查询当前日期 #}
        let topMM=$mmNow.getBoundingClientRect().top;
        let $listDocs=$mmNow.querySelectorAll("[dr-date-doc]");
        let $docNow=Array.from($listDocs).find(($doc,idx)=>{
            return $doc.getBoundingClientRect().bottom > topMM;
        });
        if($docNow){
            this.dispatchEvent(new CustomEvent("BS_MAIN_SCROLL", {
                detail:{
                    strDateNow:$docNow.getAttribute("dr-date-doc"),
                }
            }))
            console.log("now Date",$docNow.getAttribute("dr-date-doc"));
        }else debugger;
    }

    {# 月份计算坐标 #}
    let $listMM=$timelineWrapper.querySelectorAll(".wapper-mm");
    {# 上一个当前月 #}
    let $mmLast=$listMM[0];
    let $mmNow=$listMM[0];
    //slideMain.findNow=function(pos){
    //    if($listMMNow){
    //        return 
    //    }
    //}
    slideMain.on('scroll', (pos) => {
        {# PC:第一个跨出左屏幕的 ,同时记录最后一个 x <-pos.x #}
        let idxNearest = 0;
        let paddingLeftTimelineWrapper=$timelineWrapper.getBoundingClientRect().left;
        let $mmLeftOut=Array.from($listMM).find(($mm,idx)=>{
            idxNearest = idx;
            //return $mm.getBoundingClientRect().right > -pos.x;
            return $mm.getBoundingClientRect().left + ($mm.getBoundingClientRect().width*3/4) > paddingLeftTimelineWrapper;
        });
        //let $listMMNow=listMMLeft.find(($mm)=>( $mm.getBoundingClientRect().x <= -pos.x );
        $mmNow=false;
        if($mmLeftOut){
            $mmNow=$mmLeftOut;
        }else{
            $mmNow = $listMM[idxNearest+1] ? $listMM[idxNearest+1] : ($listMM[idxNearest]?$listMM[idxNearest]:false) ;
        }
        if(!$mmNow)debugger;
        else{
            {# 是否需要改变class #}
            if($mmNow!=$mmLast){                
                $mmLast.classList.remove("now");
                $mmLast=$mmNow;                
                {# console.log("now:"+$mmNow.getAttribute("dr-bs-wrapper"),$mmNow.getBoundingClientRect().left,pos.x,$mmNow.getBoundingClientRect().right) #}
            }
            $mmNow.classList.add("now");

            this.funScrollTimeline($mmNow);


        }
    })
    
    var mutationObserver = new MutationObserver(function (mutations) {
        
        let status=window.getComputedStyle($timelineWrapper).getPropertyValue('display');
        {# //显示时初始化内容 #}
        if(status!="none"){
            //let domListBSMM=document.querySelectorAll("[dr-bs-wrapper]");
            $listMM.forEach(($bsMM)=>{
                let idxMM=$bsMM.getAttribute("ms-controller");
                let objName="bs-"+idxMM;
                //let $mm=$timelineWrapper.querySelectorAll
                that[objName]=that[objName] ||  new BetterScroll.createBScroll($bsMM, objInitBSMM)
                that[objName].on('beforeScrollStart', that[objName].refresh)
                that[objName].on("scroll",(pos)=>{//this===MutationObserver
                    if($bsMM.classList.contains("now"))that.funScrollTimeline($bsMM);
                })
                that[objName].refresh();
            })
            console.log("监听到#timelineWrapper显示，初始化纵向月份");
        }
        return;
    })

    mutationObserver.observe($timelineWrapper, {
        childList: true, // 子节点的变动（新增、删除或者更改）
        attributes: true, // 属性的变动
        attributeFilter: ['class', 'style'], // 观察特定属性
        //characterData: true, // 节点内容或节点文本的变动
        //subtree: true // 是否将观察器应用于该节点的所有后代节点
    })


    </script>

</div>